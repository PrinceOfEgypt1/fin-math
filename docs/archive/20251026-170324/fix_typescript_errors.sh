#!/bin/bash
set -e

# ============================================================================
# SCRIPT DE CORRE√á√ÉO DE ERROS TYPESCRIPT - API FINMATH
# ============================================================================
# Aplica todas as 16 corre√ß√µes de tipo 'unknown' automaticamente
# Uso: ./fix_typescript_errors.sh [caminho-do-projeto]
# ============================================================================

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configura√ß√£o
PROJECT_ROOT="${1:-./packages/api}"
BACKUP_DIR=".backup_$(date +%Y%m%d_%H%M%S)"

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë  üîß CORRE√á√ÉO DE ERROS TYPESCRIPT - FINMATH    ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# ============================================================================
# FASE 1: VALIDA√á√ÉO
# ============================================================================
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}FASE 1: Valida√ß√£o${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

if [ ! -d "$PROJECT_ROOT" ]; then
    echo -e "${RED}‚ùå Erro: Diret√≥rio $PROJECT_ROOT n√£o encontrado${NC}"
    echo "Uso: $0 [caminho-do-projeto]"
    echo "Exemplo: $0 ~/workspace/fin-math/packages/api"
    exit 1
fi

cd "$PROJECT_ROOT"
echo -e "${GREEN}‚úÖ Diret√≥rio encontrado: $(pwd)${NC}"

# Verificar se √© um projeto Node.js
if [ ! -f "package.json" ]; then
    echo -e "${RED}‚ùå Erro: package.json n√£o encontrado${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ package.json encontrado${NC}"

# ============================================================================
# FASE 2: BACKUP
# ============================================================================
echo ""
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}FASE 2: Backup${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

mkdir -p "$BACKUP_DIR"
echo -e "${BLUE}üì¶ Criando backup em: $BACKUP_DIR${NC}"

# Fazer backup dos arquivos que ser√£o modificados
if [ -d "src" ]; then
    cp -r src "$BACKUP_DIR/"
    echo -e "${GREEN}‚úÖ Backup de src/ criado${NC}"
fi

if [ -f "package.json" ]; then
    cp package.json "$BACKUP_DIR/"
    echo -e "${GREEN}‚úÖ Backup de package.json criado${NC}"
fi

# ============================================================================
# FASE 3: INSTALAR DEPEND√äNCIAS
# ============================================================================
echo ""
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}FASE 3: Instalando Depend√™ncias${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# Detectar gerenciador de pacotes
if [ -f "pnpm-lock.yaml" ]; then
    PKG_MANAGER="pnpm"
elif [ -f "yarn.lock" ]; then
    PKG_MANAGER="yarn"
else
    PKG_MANAGER="npm"
fi

echo -e "${BLUE}üì¶ Usando: $PKG_MANAGER${NC}"

# Instalar @types/express
echo -e "${BLUE}Installing @types/express...${NC}"
$PKG_MANAGER add -D @types/express@^4.17.21
echo -e "${GREEN}‚úÖ @types/express instalado${NC}"

# Instalar @types/node
echo -e "${BLUE}Installing @types/node...${NC}"
$PKG_MANAGER add -D @types/node@^20.10.0
echo -e "${GREEN}‚úÖ @types/node instalado${NC}"

# Instalar @types/cors se necess√°rio
if grep -q "cors" package.json; then
    echo -e "${BLUE}Installing @types/cors...${NC}"
    $PKG_MANAGER add -D @types/cors@^2.8.17
    echo -e "${GREEN}‚úÖ @types/cors instalado${NC}"
fi

# ============================================================================
# FASE 4: APLICAR CORRE√á√ïES TYPESCRIPT
# ============================================================================
echo ""
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}FASE 4: Aplicando Corre√ß√µes TypeScript${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

CORRECTIONS=0

# Fun√ß√£o para aplicar corre√ß√£o em um arquivo
apply_corrections() {
    local file="$1"
    
    if [ ! -f "$file" ]; then
        return
    fi
    
    echo -e "${BLUE}üîß Processando: $file${NC}"
    
    # Corre√ß√£o 1: catch (error) ‚Üí catch (error: unknown)
    if grep -q "catch (error)" "$file" 2>/dev/null; then
        sed -i.bak 's/catch (error)/catch (error: unknown)/g' "$file"
        echo "  ‚úì Adicionado tipo 'unknown' em catch blocks"
        ((CORRECTIONS++))
    fi
    
    # Corre√ß√£o 2: catch(error) ‚Üí catch (error: unknown) (sem espa√ßo)
    if grep -q "catch(error)" "$file" 2>/dev/null; then
        sed -i.bak 's/catch(error)/catch (error: unknown)/g' "$file"
        echo "  ‚úì Adicionado tipo 'unknown' em catch blocks (sem espa√ßo)"
        ((CORRECTIONS++))
    fi
    
    # Corre√ß√£o 3: Imports de Express sem tipos
    if grep -q "import express from 'express'" "$file" 2>/dev/null; then
        # N√£o fazer substitui√ß√£o autom√°tica - muito arriscado
        echo "  ‚ö†Ô∏è  ATEN√á√ÉO: Encontrado import sem tipos. Revisar manualmente:"
        echo "     import express from 'express'  ‚Üí import { Request, Response } from 'express'"
    fi
    
    # Remover arquivo de backup .bak
    rm -f "${file}.bak"
}

# Processar todos os arquivos TypeScript
if [ -d "src" ]; then
    echo -e "${BLUE}Processando arquivos em src/...${NC}"
    
    # Controllers
    for file in src/controllers/*.ts; do
        apply_corrections "$file"
    done
    
    # Services
    for file in src/services/*.ts; do
        apply_corrections "$file"
    done
    
    # Routes
    for file in src/routes/*.ts; do
        apply_corrections "$file"
    done
    
    # Server
    if [ -f "src/server.ts" ]; then
        apply_corrections "src/server.ts"
    fi
    
    # Qualquer outro .ts
    find src -name "*.ts" -type f | while read -r file; do
        apply_corrections "$file"
    done
fi

echo -e "${GREEN}‚úÖ $CORRECTIONS corre√ß√µes aplicadas${NC}"

# ============================================================================
# FASE 5: CRIAR HELPER PARA TYPE GUARDS
# ============================================================================
echo ""
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}FASE 5: Criando Utilit√°rios${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# Criar diret√≥rio de utils se n√£o existir
mkdir -p src/utils

# Criar arquivo de error handling utilities
cat > src/utils/error-handler.ts << 'EOF'
/**
 * Utilit√°rios para tratamento de erros com type safety
 */

/**
 * Extrai mensagem de erro com type guard
 */
export function getErrorMessage(error: unknown): string {
  if (error instanceof Error) {
    return error.message;
  }
  
  if (typeof error === 'string') {
    return error;
  }
  
  return 'Erro desconhecido';
}

/**
 * Verifica se √© um erro com c√≥digo
 */
export function hasErrorCode(error: unknown): error is { code: string } {
  return (
    typeof error === 'object' &&
    error !== null &&
    'code' in error &&
    typeof (error as { code: unknown }).code === 'string'
  );
}

/**
 * Formata resposta de erro padronizada
 */
export function formatErrorResponse(error: unknown, defaultCode = 'INTERNAL_ERROR') {
  const message = getErrorMessage(error);
  const code = hasErrorCode(error) ? error.code : defaultCode;
  
  return {
    error: {
      code,
      message
    }
  };
}
EOF

echo -e "${GREEN}‚úÖ Criado: src/utils/error-handler.ts${NC}"

# ============================================================================
# FASE 6: VALIDA√á√ÉO
# ============================================================================
echo ""
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}FASE 6: Valida√ß√£o${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

# Type check
echo -e "${BLUE}Executando type check...${NC}"
if $PKG_MANAGER run typecheck 2>&1 | tee /tmp/typecheck.log; then
    echo -e "${GREEN}‚úÖ Type check passou!${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Type check com erros. Verifique:${NC}"
    grep "error TS" /tmp/typecheck.log | head -10
fi

# Contar erros restantes
ERROR_COUNT=$(grep -c "error TS" /tmp/typecheck.log 2>/dev/null || echo "0")
echo ""
echo -e "${BLUE}üìä Erros TypeScript restantes: $ERROR_COUNT${NC}"

# ============================================================================
# FASE 7: INSTRU√á√ïES FINAIS
# ============================================================================
echo ""
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${YELLOW}FASE 7: Pr√≥ximos Passos${NC}"
echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

echo ""
echo -e "${GREEN}‚úÖ Corre√ß√µes autom√°ticas aplicadas: $CORRECTIONS${NC}"
echo ""
echo -e "${BLUE}üìã A√á√ïES MANUAIS NECESS√ÅRIAS:${NC}"
echo ""
echo "1Ô∏è‚É£  Revisar imports de Express nos arquivos:"
echo "    ‚ùå REMOVER: import express from 'express'"
echo "    ‚úÖ ADICIONAR: import { Request, Response, NextFunction } from 'express'"
echo ""
echo "2Ô∏è‚É£  Em cada catch block, substituir:"
echo "    ‚ùå res.json({ error: error.message })"
echo "    ‚úÖ res.json({ error: { code: 'ERROR_CODE', message: getErrorMessage(error) } })"
echo ""
echo "3Ô∏è‚É£  Importar o helper criado:"
echo "    import { getErrorMessage, formatErrorResponse } from '@/utils/error-handler'"
echo ""
echo "4Ô∏è‚É£  Testar a compila√ß√£o:"
echo "    $PKG_MANAGER run typecheck"
echo "    $PKG_MANAGER run build"
echo ""
echo -e "${BLUE}üì¶ Backup criado em: $BACKUP_DIR${NC}"
echo -e "${BLUE}Para restaurar: cp -r $BACKUP_DIR/src/* src/${NC}"
echo ""
echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${GREEN}‚úÖ Script conclu√≠do!${NC}"
echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
